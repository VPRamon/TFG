#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "exploits.h"
#include "lists.h"
#include "utils.h"

void clean(char * input){
    int i = 0;
    int j = 0;
    int aux = 0;
    char c;
    while((c = input[i++]) != '\0' ){
        if(aux == 0 && c == 32)
            continue;
        
        if(c < 32)
            continue;
        
        if(c == 34)
            continue;
        
        input[j++] = c;
        aux = 1;
    }
    input[j++] = '\0';
}


struct exploit *get_new_exploit(char *string){
    struct exploit *exploit = (struct exploit *)malloc(sizeof(struct exploit));
    
    char *token = strtok_r(string, ",", &string);
    char *name = NULL; //strtok_r(token, ":", &token) ;
    
    while(token != NULL){
        name = strtok_r(token, ":", &token);
        
        if(!strcmp(name, "Title"))
            exploit->title = token;
        
        else if(!strcmp(name, "EDB-ID"))
            exploit->EDB_ID = token;
        
        else if(!strcmp(name, "Date"))
            exploit->date = token;
        
        else if(!strcmp(name, "Author"))
            exploit->author = token;
        
        else if(!strcmp(name, "Type"))
            exploit->type = token;
        
        else if(!strcmp(name, "Platform"))
            exploit->platform = token;
        
        else if(!strcmp(name, "Path"))
            exploit->path = token;
    
        token = strtok_r(string, ",", &string);
    }
    
    return exploit;
}

list *parse(char *json_string){
    if(json_string == NULL)
        return NULL;
    
    list *l = new_list();    
    char *item = NULL;
    char *name = NULL;
    //int a,z;
    
    while(strncmp(json_string, "RESULTS_EXPLOIT", 15))
        json_string++;
    
    json_string += 18;
    
    char* exploit = strtok_r(json_string, "}", &json_string);
    
    while( json_string[0] == ',' ){
        push(l, get_new_exploit(++exploit));
        json_string++;
        exploit = strtok_r(json_string, "}", &json_string);
    }
    
    if(json_string[0] == '\0')
        return NULL;
    
    push(l, get_new_exploit(++exploit));
    json_string++;
    exploit = strtok_r(json_string, "}", &json_string);
        
    return l;
}

list *search_exploit(char *release){
    char input[100] = "searchsploit -j linux kernel ";
    strcat(input, release);
    char *out = system_cmd(input, 64);
    clean(out);
    list *exploits = parse(out);
}

void free_exploits(list *exploits){
    
    element *p = exploits->last_element;
    while(p != NULL){
        /*struct exploit *xplt = p->content;
        if(xplt->title)
            free(xplt->title);
        if(xplt->EDB_ID)
            free(xplt->EDB_ID);
        if(xplt->date)
            free(xplt->date);
        if(xplt->author)
            free(xplt->author);
        if(xplt->type)
            free(xplt->type);
        if(xplt->platform)
            free(xplt->platform);
        if(xplt->path)
            free(xplt->path);
        */
        pop(exploits);
        p = exploits->last_element;
    }
    
}

void edit_exploit(struct exploit *xplt){
    char cp[50]  = "cp ";

    strcat(cp, xplt->path);
    strcat(cp, " ./resources/exploits");
    
    system(cp);
    system("vim ./resources/exploits");
}