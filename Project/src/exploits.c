#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "exploits.h"
#include "lists.h"
#include "utils.h"

void clean(char * input){
    int i = 0;
    int j = 0;
    int aux = 0;
    char c;
    while((c = input[i++]) != '\0' ){
        if(aux == 0 && c == 32)
            continue;
        
        if(c < 32)
            continue;
        
        if(c == 34)
            continue;
        
        input[j++] = c;
        aux = 1;
    }
    input[j++] = '\0';
}


struct exploit *get_new_exploit(char *string){
    struct exploit *exploit = (struct exploit *)malloc(sizeof(struct exploit));
    
    char *token = strtok_r(string, ",", &string);
    char *name = NULL; //strtok_r(token, ":", &token) ;
    
    while(token != NULL){
        name = strtok_r(token, ":", &token);
        
        if(!strcmp(name, "Title"))
            exploit->title = token;
        
        else if(!strcmp(name, "EDB-ID"))
            exploit->EDB_ID = token;
        
        else if(!strcmp(name, "Date"))
            exploit->date = token;
        
        else if(!strcmp(name, "Author"))
            exploit->author = token;
        
        else if(!strcmp(name, "Type"))
            exploit->type = token;
        
        else if(!strcmp(name, "Platform"))
            exploit->platform = token;
        
        else if(!strcmp(name, "Path"))
            exploit->path = token;
    
        token = strtok_r(string, ",", &string);
    }
    
    return exploit;
}

list *parse(char *json_string){
    if(json_string == NULL)
        return NULL;
    
    list *l = new_list();    
    char *item = NULL;
    char *name = NULL;
    //int a,z;
    
    while(strncmp(json_string, "RESULTS_EXPLOIT", 15))
        json_string++;
    
    json_string += 18;
    
    char* exploit = strtok_r(json_string, "}", &json_string);
    
    while( json_string[0] == ',' ){
        push(l, get_new_exploit(++exploit));
        json_string++;
        exploit = strtok_r(json_string, "}", &json_string);
    }
    
    if(json_string[0] == '\0')
        return NULL;
    
    push(l, get_new_exploit(++exploit));
    json_string++;
    exploit = strtok_r(json_string, "}", &json_string);
        
    return l;
}

list *search_exploit(char *release){
    
    char input[100] = "searchsploit -j linux kernel ";
    strcat(input, release);
    char *out = system_cmd(input, 64);
    clean(out);
    list *exploits = parse(out); 
    
}

void free_exploits(list *exploits){
    
    element *p = exploits->last_element;
    while(p != NULL){
        /*struct exploit *xplt = p->content;
        if(xplt->title)
            free(xplt->title);
        if(xplt->EDB_ID)
            free(xplt->EDB_ID);
        if(xplt->date)
            free(xplt->date);
        if(xplt->author)
            free(xplt->author);
        if(xplt->type)
            free(xplt->type);
        if(xplt->platform)
            free(xplt->platform);
        if(xplt->path)
            free(xplt->path);
        */
        pop(exploits);
        p = exploits->last_element;
    }
    
}

void edit_exploit(struct exploit *xplt){
    
    //cpoy file to resources
    char cp[50]  = "cp ";
    strcat(cp, xplt->path);
    strcat(cp, " ../resources/exploits");
    system(cp);
    
    //get file name
    char filename[100];
    strcpy(filename, xplt->path);
    char* type = strtok(filename, ".");
    type = strtok(NULL, "\0");
    
    char filepath[100] = "vim ../resources/exploits/";
    strcat(filepath, xplt->EDB_ID);
    strcat(filepath, ".");
    strcat(filepath, type);
    
    //edit file with vim
    strcat(cp, xplt->path);
    system(filepath);
    system("clear");
    
}

void run_exploit(struct exploit *xplt){
    //puts(xplt->path);
    char path[100] = "gcc ";
    char out_name[50] = " -o ";
    strcat(path, xplt->path);
    printf("path: %s\n", path);
    strcat(out_name, xplt->EDB_ID);
    printf("title: %s\n", out_name);
    strcat(path, out_name);
    printf("command: %s\n", path);
    system(path);
}


void load_exploit(list *exploits, char *dir){
    
    struct exploit *exploit = (struct exploit *)malloc(sizeof(struct exploit));
    
    char *n = (char *)malloc(sizeof(char)*5);
    strcpy(n, "none");
    
    
    char *title = (char *)malloc(sizeof(char)*50);
    
    char* path = (char *)malloc(sizeof(char)*100);
    strcpy(path, dir);
            
    char* path_tmp = (char *)malloc(sizeof(char)*100);
    strcpy(path_tmp, dir);
    
    char *token = strtok_r(path_tmp, "/", &path_tmp);
    
    while(token != NULL){
        strcpy(title, token);
        token = strtok_r(path_tmp, "/", &path_tmp);
    }
    title = strtok(title, ".");
    
    exploit->title = title;

    exploit->EDB_ID = title;
        
    exploit->date = n;
    
    exploit->author = n;
    
    exploit->type = n;
    
    exploit->platform = n;
    
    exploit->path = path;
    
    push(exploits, exploit);
}
